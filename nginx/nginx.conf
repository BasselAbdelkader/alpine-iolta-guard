server {
    listen 80;
    server_name 138.68.109.92;
    client_max_body_size 50M;

    root /usr/share/nginx/html;

    # Main index page
    location = / {
        try_files /html/login.html =404;
        add_header Cache-Control "no-cache, must-revalidate";
    }

    # Redirect /checks to print-checks
    location = /checks {
        try_files /html/print-checks.html =404;
        add_header Cache-Control "no-cache, must-revalidate";
    }

    # Redirect /approvals to approval-dashboard
    location = /approvals {
        try_files /html/approval-dashboard.html =404;
        add_header Cache-Control "no-cache, must-revalidate";
    }

    # Redirect /bank to bank-accounts
    location ~ ^/bank/?$ {
        try_files /html/bank-accounts.html =404;
        add_header Cache-Control "no-cache, must-revalidate";
    }

    # Redirect /bank-accounts to bank-accounts
    location ~ ^/bank-accounts/?$ {
        try_files /html/bank-accounts.html =404;
        add_header Cache-Control "no-cache, must-revalidate";
    }

    # Redirect /bank-transactions to bank-transactions
    location ~ ^/bank-transactions/?$ {
        try_files /html/bank-transactions.html =404;
        add_header Cache-Control "no-cache, must-revalidate";
    }

    # Client detail page /clients/{id}
    location ~ ^/clients/\d+$ {
        try_files /html/client-detail.html =404;
        add_header Cache-Control "no-cache, must-revalidate";
    }

    # Case detail page /cases/{id}
    location ~ ^/cases/\d+$ {
        try_files /html/case-detail.html =404;
        add_header Cache-Control "no-cache, must-revalidate";
    }

    # Vendor detail page /vendors/{id}
    location ~ ^/vendors/\d+$ {
        try_files /html/vendor-detail.html =404;
        add_header Cache-Control "no-cache, must-revalidate";
    }

    # Proxy Case Ledger PDF to backend
    location ~ ^/clients/cases/\d+/print/?$ {
        proxy_pass http://backend:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Proxy Client Print Reports to backend
    location ~ ^/clients/print(-with-cases)?/?$ {
        proxy_pass http://backend:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # HTML pages (login, dashboard, clients, etc.)
    location / {
        # First try exact file, then .html extension in html/ folder
        try_files $uri /html$uri.html /html$uri /html/login.html;
        add_header Cache-Control "no-cache, must-revalidate";
    }

    # Static assets (js, css, images, static)
    location ~* ^/(js|css|images|fonts|static)/ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # Favicon
    location ~* \.(ico|png|svg)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # Backend API
    location /api/ {
        proxy_pass http://backend:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 300;
        proxy_connect_timeout 300;
        proxy_send_timeout 300;
    }

    # Django admin
    location /admin/ {
        proxy_pass http://backend:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # Health check
    location /health {
        access_log off;
        return 200 "OK\n";
        add_header Content-Type text/plain;
    }
}
