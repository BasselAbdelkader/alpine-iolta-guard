<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transaction Audit Trail</title>

    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="96x96" href="/favicon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="shortcut icon" href="/favicon.ico">
    <link rel="apple-touch-icon" href="/favicon.png">

    <style>
        @page {
            size: A4 landscape;
            margin: 0.5in;
            /* Hide browser default headers and footers */
            margin-top: 0.5in;
            margin-bottom: 0.5in;
        }

        @media print {
            body {
                margin: 0;
                padding: 15px;
            }
            .no-print {
                display: none !important;
            }
            /* Hide browser URL header/footer */
            @page {
                margin-header: 0;
                margin-footer: 0;
            }
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 10pt;
            color: #333;
            line-height: 1.3;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 3px solid #2c3e50;
            padding-bottom: 10px;
        }

        .header h1 {
            margin: 0 0 5px 0;
            font-size: 18pt;
            color: #2c3e50;
        }

        .header .firm-name {
            font-size: 12pt;
            font-weight: 600;
            margin-bottom: 3px;
        }

        .header .firm-info {
            font-size: 9pt;
            color: #666;
        }

        /* Transaction Info */
        .transaction-info {
            margin-bottom: 15px;
            padding: 10px;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
        }

        .transaction-info table {
            width: 100%;
            border-collapse: collapse;
        }

        .transaction-info td {
            padding: 3px 8px;
            font-size: 9pt;
        }

        .transaction-info td:first-child {
            font-weight: 600;
            width: 150px;
        }

        /* Audit Table */
        .audit-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 9pt;
        }

        .audit-table thead {
            background-color: #2c3e50;
            color: white;
        }

        .audit-table th {
            padding: 8px 6px;
            text-align: left;
            font-weight: 600;
            border: 1px solid #2c3e50;
        }

        .audit-table td {
            padding: 6px;
            border: 1px solid #dee2e6;
            vertical-align: top;
        }

        .audit-table tbody tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        .audit-table tbody tr:hover {
            background-color: #e9ecef;
        }

        /* Status badges */
        .badge {
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 8pt;
            font-weight: 600;
            display: inline-block;
            white-space: nowrap;
        }

        .badge-created { background-color: #28a745; color: white; }
        .badge-voided { background-color: #dc3545; color: white; }
        .badge-cleared { background-color: #17a2b8; color: white; }
        .badge-updated { background-color: #ffc107; color: #333; }

        /* Amount changes */
        .amount-change {
            font-family: 'Courier New', monospace;
            white-space: nowrap;
        }

        .amount-increase { color: #28a745; font-weight: 600; }
        .amount-decrease { color: #dc3545; font-weight: 600; }

        /* Footer */
        .footer {
            margin-top: 20px;
            padding-top: 10px;
            border-top: 1px solid #dee2e6;
            text-align: center;
            font-size: 8pt;
            color: #666;
        }

        /* Column widths */
        .col-date { width: 12%; }
        .col-action { width: 8%; }
        .col-user { width: 10%; }
        .col-amount { width: 18%; }
        .col-status { width: 15%; }
        .col-reason { width: 25%; }
        .col-ip { width: 12%; }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <h1>TRANSACTION AUDIT TRAIL</h1>
        <div class="firm-name" id="firmName">Sample Law Firm</div>
        <div class="firm-info" id="firmInfo">123 Legal Plaza, New York, NY 10001 | 555-LAW-FIRM | admin@samplelawfirm.com</div>
    </div>

    <!-- Transaction Information -->
    <div class="transaction-info">
        <table>
            <tr>
                <td>Transaction Number:</td>
                <td id="txnNumber">-</td>
                <td>Client:</td>
                <td id="txnClient">-</td>
            </tr>
            <tr>
                <td>Date:</td>
                <td id="txnDate">-</td>
                <td>Case:</td>
                <td id="txnCase">-</td>
            </tr>
            <tr>
                <td>Type:</td>
                <td id="txnType">-</td>
                <td>Current Amount:</td>
                <td id="txnAmount">-</td>
            </tr>
            <tr>
                <td>Payee:</td>
                <td id="txnPayee">-</td>
                <td>Current Status:</td>
                <td id="txnStatus">-</td>
            </tr>
            <tr>
                <td colspan="4"><strong>Description:</strong> <span id="txnDescription">-</span></td>
            </tr>
        </table>
    </div>

    <!-- Audit History Table -->
    <h3 style="margin: 15px 0 5px 0; font-size: 11pt;">Complete Audit History (<span id="auditCount">0</span> entries)</h3>
    <table class="audit-table">
        <thead>
            <tr>
                <th class="col-date">Date & Time</th>
                <th class="col-action">Action</th>
                <th class="col-user" style="background-color: #0d6efd; color: white;">ðŸ‘¤ User (Who)</th>
                <th class="col-amount">Amount Change</th>
                <th class="col-status">Status Change</th>
                <th class="col-reason">Reason / Notes</th>
                <th class="col-ip">IP Address</th>
            </tr>
        </thead>
        <tbody id="auditTableBody">
            <tr>
                <td colspan="7" style="text-align: center; padding: 20px;">Loading audit history...</td>
            </tr>
        </tbody>
    </table>

    <!-- Footer -->
    <div class="footer">
        <strong>IOLTA Trust Account Management System</strong> |
        Generated: <span id="generatedDate"></span> |
        Page <span class="pageNumber"></span> of <span class="totalPages"></span>
    </div>

    <script>
        // URL Parameters Helper
        class URLParams {
            constructor(search) {
                this.params = {};
                if (search) {
                    search.slice(1).split('&').forEach(pair => {
                        const [key, value] = pair.split('=');
                        this.params[decodeURIComponent(key)] = decodeURIComponent(value || '');
                    });
                }
            }
            get(key) {
                return this.params[key];
            }
        }

        const urlParams = new URLParams(window.location.search);
        const txnId = urlParams.get('id');

        // Load law firm info
        async function loadLawFirm() {
            try {
                const response = await fetch('/api/v1/law-firm/');
                const firm = await response.json();
                document.getElementById('firmName').textContent = firm.firm_name || 'Sample Law Firm';
                document.getElementById('firmInfo').textContent =
                    `${firm.address || ''}, ${firm.city || ''}, ${firm.state || ''} ${firm.zip_code || ''} | ${firm.phone || ''} | ${firm.email || ''}`;
            } catch (error) {
                console.error('Error loading firm info:', error);
            }
        }

        // Load audit trail
        async function loadAuditTrail() {
            try {
                const response = await fetch(`/api/v1/bank-accounts/bank-transactions/${txnId}/audit_history/`);
                const data = await response.json();

                if (!data.success) {
                    // alert('Error loading audit trail');
                    return;
                }

                const txn = data.transaction;

                // Populate transaction details
                document.getElementById('txnNumber').textContent = txn.transaction_number || '-';
                document.getElementById('txnDate').textContent = txn.transaction_date || '-';
                document.getElementById('txnType').textContent = txn.transaction_type_display || '-';
                document.getElementById('txnAmount').textContent = '$' + parseFloat(txn.amount).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                document.getElementById('txnPayee').textContent = txn.payee || '-';
                document.getElementById('txnStatus').textContent = txn.status_display || '-';
                document.getElementById('txnDescription').textContent = txn.description || '-';
                document.getElementById('txnClient').textContent = txn.client_name || '-';

                let caseInfo = '-';
                if (txn.case_number) {
                    caseInfo = txn.case_number;
                    if (txn.case_title) {
                        caseInfo += ' - ' + txn.case_title;
                    }
                }
                document.getElementById('txnCase').textContent = caseInfo;

                // Populate audit history
                populateAuditTable(data.audit_logs);
                document.getElementById('auditCount').textContent = data.count;

                // Set generated date
                document.getElementById('generatedDate').textContent = new Date().toLocaleString('en-US', {
                    month: '2-digit',
                    day: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: true
                });

            } catch (error) {
                console.error('Error loading audit trail:', error);
                document.getElementById('auditTableBody').innerHTML =
                    '<tr><td colspan="7" style="text-align: center; color: red;">Error loading audit trail. Please try again.</td></tr>';
            }
        }

        function populateAuditTable(logs) {
            const tbody = document.getElementById('auditTableBody');
            tbody.innerHTML = '';

            if (!logs || logs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No audit history found.</td></tr>';
                return;
            }

            logs.forEach(log => {
                const row = document.createElement('tr');

                // Date & Time
                const dateCell = document.createElement('td');
                dateCell.textContent = log.action_date;
                row.appendChild(dateCell);

                // Action
                const actionCell = document.createElement('td');
                actionCell.innerHTML = getActionBadge(log.action);
                row.appendChild(actionCell);

                // User
                const userCell = document.createElement('td');
                userCell.textContent = log.action_by || 'system';
                userCell.style.fontWeight = '600';
                userCell.style.color = '#0d6efd';
                row.appendChild(userCell);

                // Amount Change
                const amountCell = document.createElement('td');
                amountCell.innerHTML = formatAmountChange(log.old_amount, log.new_amount);
                row.appendChild(amountCell);

                // Status Change
                const statusCell = document.createElement('td');
                statusCell.innerHTML = formatStatusChange(log.old_status, log.new_status);
                row.appendChild(statusCell);

                // Reason
                const reasonCell = document.createElement('td');
                reasonCell.textContent = log.change_reason || '-';
                reasonCell.style.fontSize = '8pt';
                row.appendChild(reasonCell);

                // IP Address
                const ipCell = document.createElement('td');
                ipCell.textContent = log.ip_address || '-';
                ipCell.style.fontSize = '8pt';
                ipCell.style.color = '#666';
                row.appendChild(ipCell);

                tbody.appendChild(row);
            });
        }

        function getActionBadge(action) {
            const badges = {
                'CREATED': '<span class="badge badge-created">CREATED</span>',
                'VOIDED': '<span class="badge badge-voided">VOIDED</span>',
                'CLEARED': '<span class="badge badge-cleared">CLEARED</span>',
                'UPDATED': '<span class="badge badge-updated">UPDATED</span>'
            };
            return badges[action] || `<span class="badge badge-updated">${action}</span>`;
        }

        function formatAmountChange(oldAmount, newAmount) {
            if (oldAmount === null || oldAmount === undefined) {
                return `<span class="amount-change amount-increase">Initial: $${parseFloat(newAmount).toLocaleString('en-US', {minimumFractionDigits: 2})}</span>`;
            }

            const old = parseFloat(oldAmount);
            const newAmt = parseFloat(newAmount);

            if (old === newAmt) {
                return `$${old.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
            }

            const cssClass = newAmt < old ? 'amount-decrease' : 'amount-increase';
            const arrow = newAmt < old ? 'â†“' : 'â†‘';
            return `<span class="amount-change ${cssClass}">$${old.toLocaleString('en-US', {minimumFractionDigits: 2})} ${arrow} $${newAmt.toLocaleString('en-US', {minimumFractionDigits: 2})}</span>`;
        }

        function formatStatusChange(oldStatus, newStatus) {
            if (!oldStatus) {
                return newStatus ? `<strong>${newStatus.toUpperCase()}</strong>` : '-';
            }

            if (oldStatus === newStatus) {
                return newStatus.toUpperCase();
            }

            return `${oldStatus} â†’ <strong>${newStatus.toUpperCase()}</strong>`;
        }

        // Load on page ready
        window.addEventListener('DOMContentLoaded', function() {
            loadLawFirm();
            loadAuditTrail();
        });

        // Auto-print if requested
        if (window.location.search.includes('autoprint=true')) {
            window.addEventListener('load', () => {
                setTimeout(() => window.print(), 1000);
            });
        }
    </script>
    <!-- Approval System Scripts -->
    <script src="/js/approval-badge.js?v=1764230317"></script>
    <script src="/js/approval-widget.js"></script>
</body>
</html>
