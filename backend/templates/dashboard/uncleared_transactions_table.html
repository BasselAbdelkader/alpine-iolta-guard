{% load humanize %}
{% load accounting_filters %}

{% if transactions %}
<div class="table-responsive">
    <table class="table table-striped table-hover">
        <thead class="table-dark">
            <tr>
                <th style="width: 100px;">Date</th>
                <th style="width: 80px;">Type</th>
                <th style="width: 120px;">Transaction #</th>
                <th style="width: 120px;">Amount</th>
                <th style="width: 150px;">Client</th>
                <th style="width: 150px;">Case</th>
                <th style="width: 150px;">Payee</th>
                <th>Description</th>
                <th style="width: 80px;">Days Old</th>
                <th style="width: 100px;">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for item in transactions %}
            <tr>
                <td>
                    <span class="fw-medium">{{ item.transaction.transaction_date|date:"m/d/Y" }}</span>
                </td>
                <td>
                    <span class="badge
                        {% if item.transaction.transaction_type == 'DEPOSIT' %}bg-success
                        {% elif item.transaction.transaction_type == 'WITHDRAWAL' %}bg-danger
                        {% elif item.transaction.transaction_type == 'TRANSFER_IN' %}bg-info
                        {% elif item.transaction.transaction_type == 'TRANSFER_OUT' %}bg-warning
                        {% else %}bg-secondary
                        {% endif %}">
                        {{ item.transaction.get_transaction_type_display }}
                    </span>
                </td>
                <td>
                    <span class="text-muted font-monospace">{{ item.transaction.transaction_number }}</span>
                </td>
                <td>
                    {% if item.transaction.transaction_type == 'DEPOSIT' %}
                        <span class="text-success fw-medium">{{ item.transaction.amount|format_deposit }}</span>
                    {% elif item.transaction.transaction_type == 'WITHDRAWAL' %}
                        <span class="text-danger fw-medium">{{ item.transaction.amount|format_withdrawal }}</span>
                    {% else %}
                        <span class="text-dark fw-medium">{{ item.transaction.amount|format_amount_accounting }}</span>
                    {% endif %}
                </td>
                <td>
                    {% if item.transaction.client %}
                        <a href="{% url 'clients:detail' item.transaction.client.pk %}" class="text-decoration-none">
                            {{ item.client_display }}
                        </a>
                    {% else %}
                        <span class="text-muted">{{ item.client_display }}</span>
                    {% endif %}
                </td>
                <td>
                    {% if item.transaction.case %}
                        <a href="{% url 'clients:case_detail' item.transaction.case.pk %}" class="text-decoration-none">
                            {{ item.case_display|truncatechars:20 }}
                        </a>
                    {% else %}
                        <span class="text-muted">{{ item.case_display }}</span>
                    {% endif %}
                </td>
                <td>
                    <span>{{ item.payee_display|truncatechars:20 }}</span>
                </td>
                <td>
                    <span title="{{ item.transaction.description }}">
                        {{ item.transaction.description|truncatechars:40 }}
                    </span>
                </td>
                <td>
                    <span class="badge {{ badge_class }}">{{ item.days_old }} days</span>
                </td>
                <td>
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-outline-primary" onclick="editTransaction({{ item.transaction.id }})" title="Edit Transaction">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button type="button" class="btn btn-outline-success" onclick="markCleared({{ item.transaction.id }})" title="Mark as Cleared">
                            <i class="fas fa-check"></i>
                        </button>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<div class="text-center py-4">
    <div class="text-muted mb-3">
        <i class="fas fa-check-circle fa-3x"></i>
    </div>
    <h5 class="text-muted">No uncleared transactions in this category</h5>
    <p class="text-muted">All transactions in this age group have been cleared.</p>
</div>
{% endif %}

<!-- Transaction Modal (reused from bank accounts) -->
<div class="modal fade" id="transactionModal" aria-labelledby="transactionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="transactionModalLabel">Edit Transaction</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="transactionModalForm" method="post">
                <div class="modal-body">
                    {% csrf_token %}
                    <div id="transactionModalContent">
                        <!-- Transaction form fields will be loaded here via AJAX -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="submitTransactionForm()">
                        <i class="fas fa-save"></i> Save Transaction
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Function to edit transaction (reused from case detail)
function editTransaction(transactionId) {
    console.log('Loading edit form for transaction:', transactionId);

    // Clear any previous content
    $('#transactionModalContent').empty();

    // Update modal title
    $('#transactionModalLabel').text('Edit Transaction');

    // Show modal
    $('#transactionModal').modal('show');

    // Update form action to edit URL
    $('#transactionModalForm').attr('action', '/bank-accounts/transactions/' + transactionId + '/edit/');

    // Load form content via AJAX
    $.ajax({
        url: '/bank-accounts/transactions/' + transactionId + '/edit/',
        type: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        },
        success: function(response) {
            console.log('Transaction edit form loaded successfully');
            if (response.form_html) {
                $('#transactionModalContent').html(response.form_html);
                // Initialize form functionality after content is loaded
                initializeTransactionForm();
            } else {
                $('#transactionModalContent').html('<div class="alert alert-danger">Error loading form. Please try again.</div>');
            }
        },
        error: function(xhr, status, error) {
            console.error('Error loading transaction edit form:', error);
            $('#transactionModalContent').html('<div class="alert alert-danger">Error loading form: ' + error + '</div>');
        }
    });
}

// Function to mark transaction as cleared
function markCleared(transactionId) {
    if (!confirm('Mark this transaction as cleared? This action cannot be undone.')) {
        return;
    }

    $.ajax({
        url: '/bank-accounts/transactions/' + transactionId + '/mark-cleared/',
        type: 'POST',
        data: {
            'csrfmiddlewaretoken': $('[name=csrfmiddlewaretoken]').val()
        },
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        },
        success: function(response) {
            if (response.success) {
                // Store success message for display after reload
                sessionStorage.setItem('clearedSuccessMessage', response.message || 'Transaction marked as cleared successfully.');
                location.reload(); // Refresh to show updated status
            } else {
                alert('Error marking transaction as cleared: ' + (response.message || 'Please try again.'));
            }
        },
        error: function(xhr, status, error) {
            console.error('Error marking transaction as cleared:', error);
            alert('Error marking transaction as cleared: ' + error);
        }
    });
}

// Initialize transaction form functionality (placeholder)
function initializeTransactionForm() {
    console.log('Transaction form initialized for uncleared transactions view');
    // Transaction form initialization code would go here
}

// Submit transaction form (placeholder)
function submitTransactionForm() {
    console.log('Submit transaction form called');
    // Transaction form submission code would go here
}

// Check for success messages on page load
$(document).ready(function() {
    var successMessage = sessionStorage.getItem('clearedSuccessMessage');
    if (successMessage) {
        // Remove from storage
        sessionStorage.removeItem('clearedSuccessMessage');

        // Show success message
        var alertHtml = '<div class="alert alert-success alert-dismissible fade show" role="alert">' +
            '<i class="fas fa-check-circle"></i> ' + successMessage +
            '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>' +
            '</div>';

        // Add success message to the top of the page
        $('.container-fluid').first().prepend(alertHtml);

        // Auto-dismiss after 4 seconds
        setTimeout(function() {
            $('.alert-success').fadeOut();
        }, 4000);
    }
});
</script>