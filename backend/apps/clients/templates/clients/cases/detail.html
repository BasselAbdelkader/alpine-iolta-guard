{% extends 'base.html' %}
{% load static %}
{% load humanize %}
{% load accounting_filters %}

{% block title %}Case Details - {{ case.case_title }}{% endblock %}

{% block page_title %}{% if global_law_firm %}{{ global_law_firm.firm_name }}{% else %}Case Details{% endif %}{% endblock %}

{% block help_title %}Case Details{% endblock %}

{% block extra_css %}
<link href="{% static 'css/datatables.min.css' %}" rel="stylesheet">
<style>
.case-details-table {
    font-size: 0.9rem !important;
    width: 100%;
    border-collapse: separate !important;
    border-spacing: 0;
    caption-side: top !important;
    background-color: #fff;
    border-radius: 0.375rem;
    overflow: hidden;
    box-shadow: 0 0 0 1px rgba(0,0,0,0.05);
}
.case-details-table td {
    padding: 0.75rem 1rem;
    border: none;
    border-bottom: 1px solid #e9ecef !important;
    font-size: 0.9rem !important;
    vertical-align: middle;
}
.case-details-table tr:last-child td {
    border-bottom: none !important;
}
.case-details-table tr:hover {
    background-color: #f8f9fa;
}
/* Enhanced styling for professional appearance */
.case-details-table .badge {
    font-size: 0.75rem;
    padding: 0.4rem 0.6rem;
}
.case-details-table a {
    color: #0d6efd;
    text-decoration: none;
}
.case-details-table a:hover {
    color: #0a58ca;
    text-decoration: underline;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- Success/Error Message Area -->
            <div id="messageArea" class="mb-3">
                <!-- Messages will be displayed here -->
            </div>

            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">{{ case.case_title|default:'N/A' }}</h4>
                    <div class="btn-group">
                        <a href="{% url 'clients:case_index' %}" class="btn btn-secondary">
                            <i class="fas fa-list"></i> All Cases
                        </a>
                        <button type="button" class="btn btn-primary" onclick="editCase({{ case.pk }})">
                            <i class="fas fa-edit"></i> Edit Case
                        </button>
                        <a href="{% url 'clients:detail' case.client.pk %}" class="btn btn-info">
                            <i class="fas fa-user"></i> View Client
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-12">
                            <table class="case-details-table">
                                <tbody>
                                    <tr>
                                        <td style="width: 15%; font-weight: 600; color: #495057; padding-right: 1rem;">Case Title:</td>
                                        <td style="width: 35%; padding-right: 2rem;">{{ case.case_title|default:'-' }}</td>
                                        <td style="width: 15%; font-weight: 600; color: #495057; padding-right: 1rem;">Status:</td>
                                        <td style="width: 35%;">
                                            {% if case.case_status == 'Open' %}
                                                <span class="badge bg-primary">{{ case.get_case_status_display }}</span>
                                            {% elif case.case_status == 'Pending Settlement' %}
                                                <span class="badge bg-warning">{{ case.get_case_status_display }}</span>
                                            {% elif case.case_status == 'Settled' %}
                                                <span class="badge bg-success">{{ case.get_case_status_display }}</span>
                                            {% elif case.case_status == 'Closed' %}
                                                <span class="badge bg-secondary">{{ case.get_case_status_display }}</span>
                                            {% else %}
                                                <span class="badge bg-dark">{{ case.get_case_status_display }}</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    <tr>
                                        <td style="width: 15%; font-weight: 600; color: #495057; padding-right: 1rem;">Client:</td>
                                        <td style="width: 35%; padding-right: 2rem;">
                                            <a href="{% url 'clients:detail' case.client.pk %}" class="text-decoration-none">
                                                {{ case.client.full_name }}
                                            </a>
                                        </td>
                                        <td style="width: 15%; font-weight: 600; color: #495057; padding-right: 1rem;">Case Balance:</td>
                                        <td style="width: 35%;">
                                            <strong class="h6 mb-0 {{ case_balance|balance_status_class }}">
                                                {{ case_balance|format_amount_accounting }}
                                            </strong>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td style="width: 15%; font-weight: 600; color: #495057; padding-right: 1rem;">Opened Date:</td>
                                        <td style="width: 35%; padding-right: 2rem;">{{ case.opened_date|date:"m/d/Y"|default:'-' }}</td>
                                        <td colspan="2" style="padding: 0.5rem;"></td>
                                    </tr>
                                    {% if case.case_description %}
                                    <tr>
                                        <td style="width: 15%; font-weight: 600; color: #495057; padding-right: 1rem;">Description:</td>
                                        <td style="width: 35%; padding-right: 2rem;">{{ case.case_description }}</td>
                                        <td colspan="2" style="padding: 0.5rem;"></td>
                                    </tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Message Area (appears between case details and ledger) -->
    <div id="success-message-area" class="row mt-4" style="display: none;">
        <div class="col-12">
            <div class="alert alert-success d-flex align-items-center" role="alert" style="border-left: 4px solid #28a745;">
                <i class="fas fa-check-circle me-3" style="font-size: 1.5rem;"></i>
                <div style="font-size: 1.1rem; font-weight: 500;">Transaction saved successfully</div>
            </div>
        </div>
    </div>

    <!-- Case Ledger -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-0">
                            <i class="fas fa-exchange-alt text-primary"></i>
                            Case Ledger ({{ transaction_items.count|default:0 }})
                        </h5>
                        <small class="text-muted">
                            Client: {{ case.client.full_name }} | Case: {{ case.case_title }}
                        </small>
                    </div>
                    <div class="btn-group">
                        <a href="{% url 'clients:print_case_ledger' case.pk %}" 
                           class="btn btn-outline-secondary" 
                           target="_blank"
                           title="Print case ledger">
                            <i class="fas fa-print"></i> Print Ledger
                        </a>
                        <button type="button" class="btn btn-outline-success" onclick="addTransaction('{{ case.client.id }}', '{{ case.id }}')">
                            <i class="fas fa-plus"></i> Add Transaction
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    {% if transaction_items %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover align-middle">
                            <thead class="table-dark">
                                <tr>
                                    <th style="width: 90px;" class="text-center">Date</th>
                                    <th style="width: 80px;" class="text-center">Type</th>
                                    <th style="width: 100px;" class="text-center">Ref Number</th>
                                    <th style="width: 150px;">Payee</th>
                                    <th style="width: 160px;">Description</th>
                                    <th style="width: 85px;" class="text-center">Status</th>
                                    <th style="width: 110px;" class="text-end">Amount</th>
                                    <th style="width: 110px;" class="text-end">Balance</th>
                                    <th style="width: 200px;" class="text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for entry in transaction_register %}
                                <tr>
                                    <td class="text-center">
                                        <span class="fw-medium">{{ entry.date|date:"m/d/Y" }}</span>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge
                                            {% if entry.type == 'Deposit' %}bg-success
                                            {% elif entry.type == 'Withdrawal' %}bg-danger
                                            {% elif entry.type == 'Transfer' %}bg-info
                                            {% endif %}">
                                            {{ entry.type }}
                                        </span>
                                    </td>
                                    <td class="text-center">
                                        <span class="text-muted">{{ entry.reference|default:'-' }}</span>
                                    </td>
                                    <td>
                                        <span class="fw-medium">{{ entry.payee|default:'-' }}</span>
                                    </td>
                                    <td>
                                        <span class="text-dark">
                                            {{ entry.description|default:"No description provided"|truncatechars:50 }}
                                        </span>
                                    </td>
                                    <td class="text-center">
                                        {% if entry.status == 'voided' %}
                                            <span class="badge bg-danger">Voided</span>
                                        {% elif entry.status == 'cleared' %}
                                            <span class="badge bg-success">Cleared</span>
                                        {% else %}
                                            <span class="badge bg-warning text-dark">Pending</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-end">
                                        {% if entry.status == 'voided' %}
                                            <span class="text-muted" style="text-decoration: line-through;">
                                                {% if entry.type == 'Deposit' %}
                                                    {{ entry.amount|format_deposit }} <small>(VOIDED)</small>
                                                {% elif entry.type == 'Withdrawal' %}
                                                    {{ entry.amount|format_withdrawal }} <small>(VOIDED)</small>
                                                {% else %}
                                                    {{ entry.amount|format_amount_accounting }} <small>(VOIDED)</small>
                                                {% endif %}
                                            </span>
                                        {% else %}
                                            {% if entry.type == 'Deposit' %}
                                                <span class="text-success fw-medium">{{ entry.amount|format_deposit }}</span>
                                            {% elif entry.type == 'Withdrawal' %}
                                                <span class="text-danger fw-medium">{{ entry.amount|format_withdrawal }}</span>
                                            {% else %}
                                                <span class="text-dark fw-medium">{{ entry.amount|format_amount_accounting }}</span>
                                            {% endif %}
                                        {% endif %}
                                    </td>
                                    <td class="text-end">
                                        <span class="fw-bold {{ entry.balance|balance_status_class }}">
                                            {{ entry.balance|format_amount_accounting }}
                                        </span>
                                    </td>
                                    <td class="text-center" style="white-space: nowrap; padding: 8px;">
                                        {% if entry.status == 'voided' %}
                                            <!-- Voided transaction display with audit button -->
                                            <div class="d-flex flex-column align-items-center" style="gap: 8px;">
                                                <span class="badge bg-secondary">VOIDED</span>
                                                {% if entry.void_reason %}
                                                    <div class="text-muted text-center" title="{{ entry.void_reason }}" style="line-height: 1.3; max-width: 180px;">
                                                        <strong>Reason:</strong> {{ entry.void_reason|truncatechars:25 }}
                                                    </div>
                                                {% endif %}
                                                <!-- Audit button for voided transactions -->
                                                <button type="button" class="btn btn-outline-info btn-sm" onclick="showAuditHistory({{ entry.id }})" title="View Audit History & Generate Report" style="min-width: 36px; padding: 4px 6px;">
                                                    <i class="fas fa-file-alt"></i>
                                                </button>
                                            </div>
                                        {% else %}
                                            <!-- Action buttons for active transactions -->
                                            <div class="d-flex justify-content-center" style="gap: 4px;">
                                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="editTransaction({{ entry.id }})" title="Edit Transaction" style="min-width: 36px; padding: 4px 6px;">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button type="button" class="btn btn-outline-warning btn-sm" onclick="voidTransaction({{ entry.id }})" title="Void Transaction" style="min-width: 36px; padding: 4px 6px;">
                                                    <i class="fas fa-ban"></i>
                                                </button>
                                                <button type="button" class="btn btn-outline-success btn-sm" onclick="reissueTransaction({{ entry.id }})" title="Re-issue Payment" style="min-width: 36px; padding: 4px 6px;">
                                                    <i class="fas fa-redo"></i>
                                                </button>
                                                <button type="button" class="btn btn-outline-info btn-sm" onclick="showAuditHistory({{ entry.id }})" title="View Audit History & Generate Report" style="min-width: 36px; padding: 4px 6px;">
                                                    <i class="fas fa-file-alt"></i>
                                                </button>
                                            </div>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <div class="text-muted mb-3">
                            <i class="fas fa-receipt fa-3x"></i>
                        </div>
                        <p class="text-muted">No transactions found for this case.</p>
                        <button type="button" class="btn btn-success" onclick="addTransaction('{{ case.client.id }}', '{{ case.id }}')">
                            <i class="fas fa-plus"></i> Add First Transaction
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Related Settlements -->
    {% if settlements %}
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-handshake text-warning"></i>
                        Related Settlements ({{ settlements.count }})
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Settlement #</th>
                                    <th>Date</th>
                                    <th>Total Amount</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for settlement in settlements %}
                                <tr>
                                    <td>
                                        <a href="{% url 'settlements:detail' settlement.pk %}" class="text-decoration-none">
                                            {{ settlement.settlement_number|default:'-' }}
                                        </a>
                                    </td>
                                    <td>{{ settlement.settlement_date|date:"m/d/Y" }}</td>
                                    <td>{{ settlement.total_amount|format_amount_accounting }}</td>
                                    <td>
                                        {% if settlement.status == 'PENDING' %}
                                            <span class="badge bg-warning">{{ settlement.get_status_display }}</span>
                                        {% elif settlement.status == 'IN_PROGRESS' %}
                                            <span class="badge bg-primary">{{ settlement.get_status_display }}</span>
                                        {% elif settlement.status == 'COMPLETED' %}
                                            <span class="badge bg-success">{{ settlement.get_status_display }}</span>
                                        {% else %}
                                            <span class="badge bg-secondary">{{ settlement.get_status_display }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <a href="{% url 'settlements:detail' settlement.pk %}" class="btn btn-sm btn-outline-info">
                                            <i class="fas fa-eye"></i> View
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Case Modal -->
<div class="modal fade" id="caseModal" aria-labelledby="caseModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="caseModalLabel">Edit Case</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="caseModalForm">
                <div class="modal-body">
                    {% csrf_token %}
                    <div id="caseMessageArea">
                        <!-- Success/Error messages will appear here -->
                    </div>
                    <div id="caseModalContent">
                        <!-- Case form fields will be loaded here via AJAX -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="caseSubmitBtn" onclick="submitCaseForm()">
                        <i class="fas fa-save"></i> Update Case
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Transaction Modal -->
<div class="modal fade" id="transactionModal" aria-labelledby="transactionModalLabel" aria-hidden="true" style="z-index: 1060; padding-left: 0 !important;">
    <div class="modal-dialog" style="margin: 1.75rem auto; max-width: 60vw;">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="transactionModalLabel">Add New Transaction</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="transactionModalForm" action="{% url 'bank_accounts:bank_transaction_create' %}" method="post">
                <div class="modal-body">
                    {% csrf_token %}
                    <div id="transactionModalContent">
                        <!-- Transaction form fields will be loaded here via AJAX -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="submitTransactionForm()">
                        <i class="fas fa-save"></i> Save Transaction
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Vendor Creation Modal -->
<div class="modal fade" id="vendorModal" aria-labelledby="vendorModalLabel" aria-hidden="true" style="z-index: 10050; position: fixed !important;">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="vendorModalLabel">Add New Vendor</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="vendorModalForm" action="/vendors/create-modal/" method="post">
                <div class="modal-body">
                    {% csrf_token %}
                    <div id="vendorMessageArea">
                        <!-- Success/Error messages will appear here -->
                    </div>
                    <div id="vendorModalContent">
                        <!-- Vendor form fields will be loaded here via AJAX -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="vendorSubmitBtn" onclick="submitVendorForm()">
                        <i class="fas fa-save"></i> Save Vendor
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
/* Fix modal positioning issues - account for sidebar */
#transactionModal {
    z-index: 9999 !important;
    padding-left: 0 !important;
    padding-right: 0 !important;
    position: fixed !important;
    top: 0 !important;
    left: 250px !important; /* Account for sidebar width */
}

/* Vendor modal should appear above transaction modal */
#vendorModal {
    z-index: 10050 !important;
    position: fixed !important;
    top: 0 !important;
    left: 250px !important; /* Account for sidebar width */
    width: calc(100% - 250px) !important; /* Adjust width for sidebar */
}

#vendorModal .modal-dialog {
    margin: 30px auto !important;
    max-width: 800px !important;
}

#transactionModal .modal-dialog {
    position: relative !important;
    margin: 20px auto !important;
    max-width: 60vw !important;
    width: auto !important;
    z-index: 10000 !important;
}

/* Ensure modal content is scrollable if too tall */
#transactionModal .modal-content {
    max-height: 90vh !important;
    overflow-y: auto !important;
    z-index: 10001 !important;
}

/* Hide the modal initially */
#transactionModal.fade:not(.show) {
    display: none !important;
}

/* Responsive adjustments for smaller screens */
@media (max-width: 768px) {
    #transactionModal {
        left: 0 !important;
        width: 100vw !important;
    }
    
    #transactionModal .modal-dialog {
        max-width: 80vw !important;
        margin: 10px auto !important;
    }
}

/* Audit History Modal - ensure it appears on top with proper z-index */
#auditHistoryModal {
    z-index: 10060 !important;
}

#auditHistoryModal .modal-dialog {
    z-index: 10061 !important;
}

#auditHistoryModal .modal-content {
    z-index: 10062 !important;
    background-color: #fff !important;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5) !important;
}

/* Ensure audit modal backdrop is below the modal */
.modal-backdrop {
    z-index: 10059 !important;
}

/* Print styles for voided transactions */
@media print {
    .text-decoration-line-through,
    [style*="text-decoration: line-through"] {
        text-decoration: line-through !important;
        -webkit-print-color-adjust: exact !important;
        color-adjust: exact !important;
    }

    /* Ensure voided badges are visible in print */
    .badge.bg-danger {
        background-color: #dc3545 !important;
        color: white !important;
        -webkit-print-color-adjust: exact !important;
        color-adjust: exact !important;
    }
}
</style>

<script>
// Page ready handler
$(document).ready(function() {
    // Success messages are now shown in-place before reload
    console.log('Case detail page loaded');
});

// Global functions for transaction modal
function addTransaction(clientId, caseId) {
    console.log('Loading transaction form for client:', clientId, 'case:', caseId);
    
    // Clear any previous content
    $('#transactionModalContent').empty();

    // Reset form action to create URL
    $('#transactionModalForm').attr('action', '{% url "bank_accounts:bank_transaction_create" %}');

    // Update modal title
    $('#transactionModalLabel').text('Add New Transaction');

    // Show modal with explicit configuration (no backdrop to avoid issues)
    $('#transactionModal').modal({
        backdrop: false,
        keyboard: true,
        focus: true
    }).modal('show');
    
    // Load form content via AJAX
    $.ajax({
        url: '{% url "bank_accounts:bank_transaction_create" %}',
        type: 'GET',
        data: {
            'client_id': clientId,
            'case_id': caseId
        },
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        },
        success: function(response) {
            console.log('Transaction form loaded successfully');
            if (response.form_html) {
                $('#transactionModalContent').html(response.form_html);
                // Initialize form functionality after content is loaded
                initializeTransactionForm();
            } else {
                $('#transactionModalContent').html('<div class="alert alert-danger">Error loading form. Please try again.</div>');
            }
        },
        error: function(xhr, status, error) {
            console.error('Error loading transaction form:', error);
            $('#transactionModalContent').html('<div class="alert alert-danger">Error loading form: ' + error + '</div>');
        }
    });
}

function submitTransactionForm() {
    console.log('submitTransactionForm called');
    var form = $('#transactionModalContent form');

    if (form.length === 0) {
        console.error('Form not found in modal content!');
        return;
    }

    // Ensure hidden fields are populated correctly before submission
    // Handle amount field (from display field to hidden field)
    var displayAmount = $('#id_amount_display').val();
    if (displayAmount) {
        var rawAmount = displayAmount.replace(/,/g, '');
        $('#id_amount_hidden').val(rawAmount);
    }

    // Handle payee field (from text field to form field)
    var payeeText = $('#id_payee_text').val();
    if (payeeText) {
        // Make sure payee field is properly set
        $('input[name="payee"]').val(payeeText);
    }

    // Ensure client and case are properly set
    // Enable disabled client and case fields before setting values
    $('#id_client, #id_case').prop('disabled', false);

    var currentClientId = $('#current-client-id').val();
    var currentCaseId = $('#current-case-id').val();

    if (currentClientId) {
        $('select[name="client"]').val(currentClientId);
        $('#id_client').val(currentClientId);
    }
    if (currentCaseId) {
        $('select[name="case"]').val(currentCaseId);
        $('#id_case').val(currentCaseId);
    }

    // COMPREHENSIVE VALIDATION - Check ALL required fields before submission
    var bankAccountId = $('#id_bank_account').val();
    var transactionType = $('select[name="transaction_type"]').val();
    var referenceNumber = $('#id_reference_number').val() || '';
    var payee = $('#id_payee_text').val() || '';
    var amountDisplayValue = $('#id_amount_display').val().trim();
    var amount = parseFloat($('#id_amount_hidden').val()) || 0;
    var description = $('#id_description').val() || '';
    var checkMemo = $('#id_check_memo').val() || '';
    var availableFundsText = $('#available-funds').text();
    var cleanFundsText = availableFundsText.replace(/,/g, '');
    var availableBalance = parseFloat(cleanFundsText) || 0;

    console.log('Validation - Transaction Type:', transactionType);

    // Helper function to show inline error
    function showError(fieldSelector, errorMessage) {
        var field = $(fieldSelector);
        field.addClass('is-invalid');

        // Remove existing error message if any
        field.next('.invalid-feedback').remove();

        // Add error message
        field.after('<div class="invalid-feedback d-block" style="color: #dc3545; font-size: 0.875rem; margin-top: 0.25rem;">' + errorMessage + '</div>');

        // Focus on field
        field.focus();
    }

    // Clear all previous errors
    $('.invalid-feedback').remove();
    $('.is-invalid').removeClass('is-invalid');

    // 1. Check Bank Account
    if (!bankAccountId || bankAccountId === '') {
        showError('#id_bank_account', 'Please choose a bank account.');
        return false;
    }

    // 2. Check Transaction Type
    if (!transactionType || transactionType === '' || transactionType === '---------') {
        showError('select[name="transaction_type"]', 'Type is required.');
        return false;
    }

    // 3. Check Reference Number
    if (!referenceNumber.trim()) {
        showError('#id_reference_number', 'Ref is required.');
        return false;
    }

    // 4. Check Payee
    if (!payee.trim()) {
        showError('#id_payee_text', 'Payee is required.');
        return false;
    }

    // 5. Check Amount
    if (!amountDisplayValue || amount <= 0) {
        showError('#id_amount_display', 'Amount is required and must be greater than zero.');
        return false;
    }

    // 6. Check Description
    if (!description.trim()) {
        showError('#id_description', 'Description is required.');
        return false;
    }

    // 7. Check Check Memo
    if (!checkMemo.trim()) {
        showError('#id_check_memo', 'Check Memo is required.');
        return false;
    }

    // 8. Check if withdrawal exceeds available balance
    if (transactionType === 'WITHDRAWAL' && amount > 0 && availableBalance >= 0 && amount > availableBalance) {
        showError('#id_amount_display', 'Withdrawal amount exceeds available funds of $' + availableBalance.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}));
        return false;
    }

    var formData = form.serialize();

    // Add bank account to form data if missing
    if (formData.indexOf('bank_account=') === -1 || formData.indexOf('bank_account=&') !== -1) {
        formData += '&bank_account=' + encodeURIComponent(bankAccountId);
    }

    // Get the action URL from the form's action attribute, or fall back to create URL
    var actionUrl = $('#transactionModalForm').attr('action') || '/bank-accounts/transactions/create/';

    console.log('Form action:', actionUrl);
    console.log('Form data:', formData);

    // Disable submit button to prevent double submission
    $('button[onclick="submitTransactionForm()"]').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Saving...');

    $.ajax({
        url: actionUrl,
        type: 'POST',
        data: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        },
        success: function(response) {
            console.log('Success response:', response);
            console.log('Response success flag:', response.success);
            console.log('Response has form_html:', !!response.form_html);
            console.log('Response message:', response.message);

            if (response.success === true) {
                console.log('âœ… Transaction saved successfully!');

                // Close modal first
                $('#transactionModal').modal('hide');

                // Wait for modal to fully close, then show success message
                setTimeout(function() {
                    console.log('Modal closed, now showing success message...');

                    // Create success message HTML
                    var successHtml = '<div id="temp-success-msg" class="row mt-4">' +
                        '<div class="col-12">' +
                        '<div class="alert alert-success d-flex align-items-center" role="alert" style="border-left: 4px solid #28a745; font-size: 1.1rem;">' +
                        '<i class="fas fa-check-circle me-3" style="font-size: 1.5rem;"></i>' +
                        '<div style="font-weight: 500;">Transaction saved successfully</div>' +
                        '</div>' +
                        '</div>' +
                        '</div>';

                    // Find the case ledger section and insert success message before it
                    var ledgerSection = $('.row.mt-4').first();
                    console.log('Found ledger section:', ledgerSection.length);

                    if (ledgerSection.length > 0) {
                        // Insert success message before case ledger
                        ledgerSection.before(successHtml);
                        console.log('Success message inserted');

                        // Scroll to message
                        $('html, body').animate({
                            scrollTop: $('#temp-success-msg').offset().top - 100
                        }, 400);

                        // Fade out after 5 seconds, then reload
                        setTimeout(function() {
                            console.log('Fading out and reloading...');
                            $('#temp-success-msg').fadeOut(400, function() {
                                location.reload();
                            });
                        }, 5000);
                    } else {
                        console.error('Could not find ledger section');
                        location.reload();
                    }
                }, 500); // Wait 500ms for modal to close
            } else {
                console.log('Form validation failed, showing errors...');
                // Re-enable button
                $('button[onclick="submitTransactionForm()"]').prop('disabled', false).html('<i class="fas fa-save"></i> Save Transaction');

                if (response.form_html) {
                    // Replace form content with error form
                    $('#transactionModalContent').html(response.form_html);
                    // DO NOT re-initialize to prevent loop - form HTML includes all necessary JavaScript
                    console.log('Form replaced with errors - NOT re-initializing to prevent submission loop');
                } else {
                    alert('Error: ' + (response.message || 'Please check the form for errors.'));
                }
            }
        },
        error: function(xhr, status, error) {
            console.error('Error submitting form:', error);
            console.error('XHR status:', xhr.status);
            console.error('XHR response:', xhr.responseText);
            
            // Re-enable button
            $('button[onclick="submitTransactionForm()"]').prop('disabled', false).html('<i class="fas fa-save"></i> Save Transaction');
            
            alert('Error creating transaction: ' + error);
        }
    });
}

// Initialize transaction form functionality after AJAX load
function initializeTransactionForm() {
    console.log('Initializing transaction form...');

    // Initialize payee autocomplete functionality
    initializePayeeAutocomplete();

    // Toggle cleared date field
    $('#id_is_cleared').change(function() {
        if (this.checked) {
            $('#clearedDateDiv').show();
            if (!$('#id_cleared_date').val()) {
                $('#id_cleared_date').val(new Date().toISOString().split('T')[0]);
            }
        } else {
            $('#clearedDateDiv').hide();
            $('#id_cleared_date').val('');
        }
    });

    // Handle case selection change to update available funds
    $('#id_case').change(function() {
        var caseId = $(this).val();
        updateAvailableFunds(caseId);
    });

    // Remove add payee button handler - no longer needed

    // Always update available funds when form loads
    var initialCaseId = $('#id_case').val();
    if (initialCaseId) {
        console.log('Updating available funds for case:', initialCaseId);
        updateAvailableFunds(initialCaseId);
    }

    // Check if form is in restricted mode
    var clientRestricted = $('#id_client').attr('data-restricted') === 'true';
    var caseRestricted = $('#id_case').attr('data-restricted') === 'true';

    console.log('Transaction form initialized successfully');
}

// Initialize payee autocomplete functionality
function initializePayeeAutocomplete() {
    var payeeInput = $('#id_payee_name');
    var suggestionsList = $('#payee-suggestions .dropdown-menu');
    var debounceTimer;

    payeeInput.on('input', function() {
        var query = $(this).val().trim();

        // Clear previous timer
        clearTimeout(debounceTimer);

        // Hide suggestions if query is too short
        if (query.length < 2) {
            $('#payee-suggestions').hide();
            return;
        }

        // Debounce the search to avoid too many requests
        debounceTimer = setTimeout(function() {
            searchVendors(query);
        }, 300);
    });

    // Hide suggestions when clicking outside
    $(document).on('click', function(e) {
        if (!$(e.target).closest('#id_payee_name, #payee-suggestions').length) {
            $('#payee-suggestions').hide();
        }
    });

    // Handle suggestion click
    suggestionsList.on('click', 'li', function() {
        if ($(this).hasClass('add-new-payee')) {
            // Handle "Add as new payee" option
            var payeeName = $(this).data('payee-name');
            createNewPayeeSimple(payeeName);
        } else if ($(this).hasClass('vendor-option')) {
            // Handle existing vendor selection
            var vendorName = $(this).data('vendor-name');
            payeeInput.val(vendorName);
            $('#payee-suggestions').hide();
        }
    });
}

// Search vendors for autocomplete
function searchVendors(query) {
    $.ajax({
        url: '/vendors/search/',
        type: 'GET',
        data: { 'q': query },
        dataType: 'json',
        success: function(data) {
            showVendorSuggestions(data.vendors || [], query);
        },
        error: function() {
            console.error('Error searching vendors');
        }
    });
}

// Show vendor suggestions
function showVendorSuggestions(vendors, query) {
    var suggestionsList = $('#payee-suggestions .dropdown-menu');
    suggestionsList.empty();

    // Always show dropdown when typing (even if no vendors found)
    vendors.forEach(function(vendor) {
        suggestionsList.append(
            '<li class="dropdown-item vendor-option" data-vendor-name="' + vendor.vendor_name + '" style="cursor: pointer; padding: 8px 12px;">' +
            vendor.vendor_name +
            '</li>'
        );
    });

    // If no exact match found, add "Add as new payee" option
    var exactMatch = vendors.some(function(vendor) {
        return vendor.vendor_name.toLowerCase() === query.toLowerCase();
    });

    if (!exactMatch && query.trim()) {
        suggestionsList.append(
            '<li class="dropdown-divider"></li>' +
            '<li class="dropdown-item add-new-payee" data-payee-name="' + query + '" style="cursor: pointer; padding: 8px 12px; color: #007bff; font-style: italic;">' +
            '<i class="fas fa-plus me-2"></i>Add "' + query + '" as new payee' +
            '</li>'
        );
    }

    $('#payee-suggestions').show();
}

// Function to update available funds based on case balance
function updateAvailableFunds(caseId) {
    if (!caseId) {
        $('#available_funds').val('$0.00');
        return;
    }

    $.ajax({
        url: '/clients/cases/' + caseId + '/balance/',
        type: 'GET',
        dataType: 'json',
        success: function(data) {
            var balance = parseFloat(data.balance || 0);
            var formattedBalance = balance >= 0 ? '$' + balance.toFixed(2) : '$0.00';
            $('#available_funds').val(formattedBalance);
        },
        error: function() {
            $('#available_funds').val('$0.00');
        }
    });
}

// Function to create new payee (simple version without alerts)
function createNewPayeeSimple(payeeName) {
    // Open enhanced vendor creation modal instead of simple creation
    openVendorCreationModal(payeeName);
}

// Open vendor creation modal with pre-filled name
function openVendorCreationModal(vendorName) {
    console.log('Opening vendor creation modal for:', vendorName);

    // Clear any previous content
    $('#vendorModalContent').empty();
    $('#vendorMessageArea').empty();

    // Update modal title
    $('#vendorModalLabel').text(vendorName ? `Add New Vendor: ${vendorName}` : 'Add New Vendor');

    // Show modal with custom configuration to avoid backdrop conflicts
    $('#vendorModal').modal({
        backdrop: false,  // Don't create new backdrop since transaction modal already has one
        keyboard: true,
        focus: true
    }).modal('show');

    // Load vendor form via AJAX
    $.ajax({
        url: '/vendors/create-modal/',
        type: 'GET',
        data: { 'name': vendorName },
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        },
        success: function(response) {
            console.log('Vendor form loaded successfully');
            if (response.form_html) {
                $('#vendorModalContent').html(response.form_html);
            } else {
                $('#vendorModalContent').html('<div class="alert alert-danger">Error loading form. Please try again.</div>');
            }
        },
        error: function(xhr, status, error) {
            console.error('Error loading vendor form:', error);
            $('#vendorModalContent').html('<div class="alert alert-danger">Error loading form: ' + error + '</div>');
        }
    });
}

// Submit vendor creation form
function submitVendorForm() {
    console.log('submitVendorForm called');
    var form = $('#vendorModalForm');

    if (form.length === 0) {
        console.error('Vendor form not found!');
        return;
    }

    var formData = form.serialize();

    // Disable submit button to prevent double submission
    $('#vendorSubmitBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Creating...');

    $.ajax({
        url: '/vendors/create-modal/',
        type: 'POST',
        data: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        },
        success: function(response) {
            console.log('Vendor creation response:', response);
            if (response.success) {
                // Close modal
                $('#vendorModal').modal('hide');

                // Set the payee name in the transaction form
                $('#id_payee_name').val(response.vendor_name);
                $('#payee-suggestions').hide();

                // Show success message briefly
                console.log(`Vendor "${response.vendor_name}" created successfully`);
            } else {
                // Re-enable button
                $('#vendorSubmitBtn').prop('disabled', false).html('<i class="fas fa-save"></i> Save Vendor');

                if (response.form_html) {
                    $('#vendorModalContent').html(response.form_html);
                } else {
                    $('#vendorMessageArea').html('<div class="alert alert-danger">Error: ' + (response.message || 'Please check the form for errors.') + '</div>');
                }
            }
        },
        error: function(xhr, status, error) {
            console.error('Error creating vendor:', error);

            // Re-enable button
            $('#vendorSubmitBtn').prop('disabled', false).html('<i class="fas fa-save"></i> Save Vendor');

            $('#vendorMessageArea').html('<div class="alert alert-danger">Error creating vendor: ' + error + '</div>');
        }
    });
}

// Transaction edit functionality
function editTransaction(transactionId) {
    console.log('Loading edit form for transaction:', transactionId);
    
    // Clear any previous content
    $('#transactionModalContent').empty();
    
    // Update modal title
    $('#transactionModalLabel').text('Edit Transaction');
    
    // Show modal with explicit configuration (no backdrop to avoid issues)
    $('#transactionModal').modal({
        backdrop: false,
        keyboard: true,
        focus: true
    }).modal('show');
    
    // Update form action to edit URL
    $('#transactionModalForm').attr('action', '{% url 'bank_accounts:bank_transaction_edit' 0 %}'.replace('0', transactionId));
    
    // Load form content via AJAX
    $.ajax({
        url: '{% url 'bank_accounts:bank_transaction_edit' 0 %}'.replace('0', transactionId),
        type: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        },
        success: function(response) {
            console.log('Transaction edit form loaded successfully');
            if (response.form_html) {
                $('#transactionModalContent').html(response.form_html);
                // Initialize form functionality after content is loaded
                initializeTransactionForm();
            } else {
                $('#transactionModalContent').html('<div class="alert alert-danger">Error loading form. Please try again.</div>');
            }
        },
        error: function(xhr, status, error) {
            console.error('Error loading transaction edit form:', error);
            $('#transactionModalContent').html('<div class="alert alert-danger">Error loading form: ' + error + '</div>');
        }
    });
}

// Transaction void functionality
function voidTransaction(transactionId) {
    const reason = prompt('Please enter a reason for voiding this transaction:');
    if (!reason) {
        return; // User cancelled or didn't enter a reason
    }
    
    if (!confirm('Are you sure you want to void this transaction? This action cannot be undone and will exclude the transaction from future settlements.')) {
        return;
    }
    
    $.ajax({
        url: '/bank-accounts/transactions/' + transactionId + '/void/',
        type: 'POST',
        data: {
            'void_reason': reason,
            'csrfmiddlewaretoken': $('[name=csrfmiddlewaretoken]').val()
        },
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        },
        success: function(response) {
            if (response.success) {
                // Store success message for display after reload
                sessionStorage.setItem('voidSuccessMessage', response.message || 'Transaction voided successfully.');
                location.reload(); // Refresh to show voided status
            } else {
                showMessage('Error voiding transaction: ' + (response.message || 'Please try again.'), 'error');
            }
        },
        error: function(xhr, status, error) {
            console.error('Error voiding transaction:', error);
            showMessage('Error voiding transaction: ' + error, 'error');
        }
    });
}

// Re-issue transaction functionality (placeholder for future implementation)
function reissueTransaction(transactionId) {
    alert('Re-issue functionality will be implemented in a future update. This will allow generating payment checks for clients.');
    console.log('Re-issue requested for transaction:', transactionId);
    // TODO: Implement re-issue functionality for payment check generation
}

// Case edit functionality
function editCase(caseId) {
    console.log('Loading edit form for case:', caseId);
    
    // Clear any previous content
    $('#caseModalContent').empty();
    $('#caseMessageArea').empty();
    
    // Update modal title
    $('#caseModalLabel').text('Edit Case');
    
    // Show modal
    $('#caseModal').modal({
        backdrop: false,
        keyboard: true,
        focus: true
    }).modal('show');
    
    // Update form action to edit URL
    $('#caseModalForm').attr('action', '/clients/cases/' + caseId + '/edit/');
    
    // Load form content via AJAX
    $.ajax({
        url: '/clients/cases/' + caseId + '/edit/',
        type: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        },
        success: function(response) {
            console.log('Case edit form loaded successfully');
            if (response.form_html) {
                $('#caseModalContent').html(response.form_html);
            } else {
                $('#caseModalContent').html('<div class="alert alert-danger">Error loading form. Please try again.</div>');
            }
        },
        error: function(xhr, status, error) {
            console.error('Error loading case edit form:', error);
            $('#caseModalContent').html('<div class="alert alert-danger">Error loading form: ' + error + '</div>');
        }
    });
}

function submitCaseForm() {
    console.log('submitCaseForm called');
    var form = $('#caseModalForm');
    
    if (form.length === 0) {
        console.error('Case form not found!');
        return;
    }
    
    var formData = form.serialize();
    var actionUrl = form.attr('action');
    
    console.log('Case form action:', actionUrl);
    console.log('Case form data:', formData);
    
    // Disable submit button to prevent double submission
    $('#caseSubmitBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Updating...');
    
    $.ajax({
        url: actionUrl,
        type: 'POST',
        data: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        },
        success: function(response) {
            console.log('Case update success response:', response);
            if (response.success) {
                $('#caseModal').modal('hide');
                location.reload(); // Refresh the page to show updated case
            } else {
                // Re-enable button
                $('#caseSubmitBtn').prop('disabled', false).html('<i class="fas fa-save"></i> Update Case');
                
                if (response.form_html) {
                    $('#caseModalContent').html(response.form_html);
                } else {
                    $('#caseMessageArea').html('<div class="alert alert-danger">Error: ' + (response.message || 'Please check the form for errors.') + '</div>');
                }
            }
        },
        error: function(xhr, status, error) {
            console.error('Error updating case:', error);
            console.error('XHR status:', xhr.status);
            console.error('XHR response:', xhr.responseText);
            
            // Re-enable button
            $('#caseSubmitBtn').prop('disabled', false).html('<i class="fas fa-save"></i> Update Case');
            
            $('#caseMessageArea').html('<div class="alert alert-danger">Error updating case: ' + error + '</div>');
        }
    });
}

// Clean up modals on close
$('#transactionModal').on('hidden.bs.modal', function () {
    console.log('Transaction modal hidden');
    $('#transactionModalContent').empty(); // Clear content
});

$('#caseModal').on('hidden.bs.modal', function () {
    console.log('Case modal hidden');
    $('#caseModalContent').empty(); // Clear content
    $('#caseMessageArea').empty();
    $('#caseSubmitBtn').prop('disabled', false).html('<i class="fas fa-save"></i> Update Case');
});

$('#vendorModal').on('hidden.bs.modal', function () {
    console.log('Vendor modal hidden');
    $('#vendorModalContent').empty(); // Clear content
    $('#vendorMessageArea').empty();
    $('#vendorSubmitBtn').prop('disabled', false).html('<i class="fas fa-save"></i> Save Vendor');
});

// Function to show success/error messages
function showMessage(message, type = 'success') {
    const messageArea = $('#messageArea');
    const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
    const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-triangle';

    const messageHtml = `
        <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
            <i class="fas ${icon}"></i> ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    `;

    messageArea.html(messageHtml);

    // Auto-dismiss after 5 seconds
    setTimeout(function() {
        messageArea.find('.alert').fadeOut(function() {
            $(this).remove();
        });
    }, 5000);

    // Scroll to top to ensure message is visible
    $('html, body').animate({ scrollTop: 0 }, 300);
}

// Check for success messages from sessionStorage on page load
$(document).ready(function() {
    const successMessage = sessionStorage.getItem('transactionSuccessMessage');
    if (successMessage) {
        showMessage(successMessage, 'success');
        sessionStorage.removeItem('transactionSuccessMessage');
    }

    const voidSuccessMessage = sessionStorage.getItem('voidSuccessMessage');
    if (voidSuccessMessage) {
        showMessage(voidSuccessMessage, 'success');
        sessionStorage.removeItem('voidSuccessMessage');
    }
});
</script>

<!-- Audit History Modal -->
<div class="modal fade" id="auditHistoryModal" tabindex="-1" aria-labelledby="auditHistoryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="auditHistoryModalLabel">
                    <i class="fas fa-history"></i> Transaction Audit History
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="auditHistoryContent">
                    <div class="text-center py-4">
                        <i class="fas fa-spinner fa-spin fa-2x text-info"></i>
                        <p class="mt-2 text-muted">Loading audit history...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="downloadAuditReportBtn" onclick="downloadAuditReport()">
                    <i class="fas fa-print"></i> View & Print Report
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="{% static 'js/datatables.min.js' %}"></script>

<!-- Audit Trail JavaScript - Loaded AFTER jQuery and all other scripts -->
<script>
console.log('=== AUDIT TRAIL SCRIPT INITIALIZING (in extra_js block) ===');

// Define functions globally - jQuery is now available
window.currentAuditTransactionId = null;

window.showAuditHistory = function(transactionId) {
    console.log('=== AUDIT HISTORY BUTTON CLICKED ===');
    console.log('Transaction ID:', transactionId);

    // Store transaction ID for report download
    window.currentAuditTransactionId = transactionId;

    // Show modal using vanilla JS WITHOUT backdrop
    const modalEl = document.getElementById('auditHistoryModal');
    if (!modalEl) {
        console.error('Modal element not found!');
        alert('Error: Modal not found');
        return;
    }

    // Create modal without backdrop
    const modal = new bootstrap.Modal(modalEl, {
        backdrop: false,  // No backdrop (no fading overlay)
        keyboard: true    // Allow ESC key to close
    });
    modal.show();

    // Reset content to loading state
    const contentEl = document.getElementById('auditHistoryContent');
    if (contentEl) {
        contentEl.innerHTML = '<div class="text-center py-4"><i class="fas fa-spinner fa-spin fa-2x text-info"></i><p class="mt-2 text-muted">Loading audit history...</p></div>';
    }

    // Load audit history via fetch API
    fetch('/bank-accounts/transactions/' + transactionId + '/audit-history/')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.displayAuditHistory(data);
            } else {
                contentEl.innerHTML = '<div class="alert alert-danger"><i class="fas fa-exclamation-triangle"></i> ' + (data.error || 'Failed to load audit history') + '</div>';
            }
        })
        .catch(error => {
            console.error('Audit history error:', error);
            contentEl.innerHTML = '<div class="alert alert-danger"><i class="fas fa-exclamation-triangle"></i> Error loading audit history. Please try again.</div>';
        });
};

window.displayAuditHistory = function(response) {
    const transaction = response.transaction;
    const auditLogs = response.audit_logs;
    const contentEl = document.getElementById('auditHistoryContent');

    if (!contentEl) {
        console.error('Content element not found');
        return;
    }

    if (!auditLogs || auditLogs.length === 0) {
        contentEl.innerHTML = '<div class="alert alert-info"><i class="fas fa-info-circle"></i> No audit history found for this transaction.</div>';
        return;
    }

    let html = '<div class="mb-3 p-3 bg-light rounded"><h6 class="mb-2"><i class="fas fa-receipt"></i> Transaction Information</h6><div class="row"><div class="col-md-3"><strong>Transaction #:</strong> ' + transaction.transaction_number + '</div><div class="col-md-3"><strong>Date:</strong> ' + transaction.transaction_date + '</div><div class="col-md-3"><strong>Amount:</strong> $' + parseFloat(transaction.amount).toFixed(2) + '</div><div class="col-md-3"><strong>Status:</strong> <span class="badge bg-' + window.getStatusClass(transaction.status) + '">' + transaction.status + '</span></div></div><div class="row mt-2"><div class="col-md-12"><strong>Payee:</strong> ' + transaction.payee + '</div></div></div><h6 class="mb-3"><i class="fas fa-clipboard-list"></i> Audit Trail (' + auditLogs.length + ' entries)</h6><div class="table-responsive"><table class="table table-bordered table-hover table-sm"><thead class="table-dark"><tr><th style="width: 140px;">Date/Time</th><th style="width: 100px;">Action</th><th style="width: 100px;">User</th><th>Changes</th><th style="width: 120px;">Amount</th><th style="width: 100px;">Status</th><th style="width: 100px;">IP Address</th></tr></thead><tbody>';

    auditLogs.forEach(function(log) {
        let amountChange = '';
        if (log.old_amount && log.new_amount) {
            amountChange = '<small>$' + parseFloat(log.old_amount).toFixed(2) + '</small> â†’ <strong>$' + parseFloat(log.new_amount).toFixed(2) + '</strong>';
        } else if (log.new_amount) {
            amountChange = '<strong>$' + parseFloat(log.new_amount).toFixed(2) + '</strong>';
        } else {
            amountChange = '-';
        }

        let statusChange = '';
        if (log.old_status && log.new_status) {
            statusChange = '<small>' + log.old_status + '</small> â†’ <strong>' + log.new_status + '</strong>';
        } else if (log.new_status) {
            statusChange = '<strong>' + log.new_status + '</strong>';
        } else {
            statusChange = '-';
        }

        html += '<tr><td><small>' + log.action_date + '</small></td><td><span class="badge ' + log.badge_class + '">' + log.action_display + '</span></td><td><small>' + log.action_by + '</small></td><td><small>' + log.changes_summary + '</small></td><td>' + amountChange + '</td><td>' + statusChange + '</td><td><small class="text-muted">' + (log.ip_address || '-') + '</small></td></tr>';

        if (log.change_reason) {
            html += '<tr class="table-light"><td colspan="7"><small><strong>Reason:</strong> ' + log.change_reason + '</small></td></tr>';
        }
    });

    html += '</tbody></table></div>';
    contentEl.innerHTML = html;
};

window.getStatusClass = function(status) {
    if (status === 'cleared') return 'success';
    if (status === 'pending') return 'warning';
    if (status === 'voided') return 'danger';
    return 'secondary';
};

window.downloadAuditReport = function() {
    if (!window.currentAuditTransactionId) {
        alert('No transaction selected');
        return;
    }
    window.open('/bank-accounts/transactions/' + window.currentAuditTransactionId + '/audit-report/xml/', '_blank');
};

console.log('=== AUDIT TRAIL FUNCTIONS LOADED ===');
console.log('showAuditHistory:', typeof window.showAuditHistory);
console.log('downloadAuditReport:', typeof window.downloadAuditReport);

// Ensure functions are available after page load
document.addEventListener('DOMContentLoaded', function() {
    console.log('=== DOM LOADED - Functions check ===');
    console.log('showAuditHistory available:', typeof window.showAuditHistory === 'function');
    console.log('downloadAuditReport available:', typeof window.downloadAuditReport === 'function');
});
</script>
{% endblock %}

{% block help_content %}
<p>The <strong>Case Details</strong> page shows comprehensive information about a specific legal case.</p>
<h6><i class="fas fa-info-circle"></i> Case Information</h6>
<p>View all case details including status, dates, amounts, and descriptions.</p>
<h6><i class="fas fa-exchange-alt"></i> Case Ledger</h6>
<p>View all financial transactions associated with this case, including deposits, withdrawals, and transfers.</p>
<h6><i class="fas fa-handshake"></i> Related Settlements</h6>
<p>View all settlements created for this case with their current status and amounts.</p>
<h6><i class="fas fa-plus"></i> Add Transaction</h6>
<p>Use the "Add Transaction" button in the Case Ledger section to create new transactions for this case.</p>
<h6><i class="fas fa-history"></i> Audit History</h6>
<p>Click the history icon on any transaction to view complete audit trail of all changes made to that transaction.</p>
{% endblock %}
