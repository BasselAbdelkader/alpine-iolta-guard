{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Cases Management{% endblock %}

{% block page_title %}{% if global_law_firm %}{{ global_law_firm.firm_name }}{% else %}Cases{% endif %}{% endblock %}

{% block help_title %}Cases{% endblock %}

{% block extra_css %}
<link href="{% static 'css/datatables.min.css' %}" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-3">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Filter Cases</h5>
                    <button type="button" class="btn btn-primary" onclick="loadCaseForm()">
                        <i class="fas fa-plus"></i> Add New Case
                    </button>
                </div>
                <div class="card-body">
                    <form method="get" class="row g-3">
                        <div class="col-md-3">
                            <label for="search" class="form-label">Search</label>
                            <div class="position-relative">
                                <input type="text" 
                                       class="form-control" 
                                       id="search" 
                                       name="search" 
                                       value="{{ search_query }}" 
                                       placeholder="Case number, title, or client name (dynamic search)"
                                       autocomplete="off">
                                <div id="search-spinner" class="position-absolute top-50 end-0 translate-middle-y me-3" style="display: none;">
                                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                                        <span class="visually-hidden">Searching...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label for="client" class="form-label">Client</label>
                            <select name="client" class="form-control" id="client">
                                <option value="">All Clients</option>
                                {% for client in clients %}
                                    <option value="{{ client.id }}" {% if client.id|stringformat:"s" == selected_client %}selected{% endif %}>
                                        {{ client.full_name }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="status" class="form-label">Status</label>
                            <select name="status" class="form-control" id="status">
                                <option value="">All Status</option>
                                {% for value, label in status_choices %}
                                    <option value="{{ value }}" {% if value == selected_status %}selected{% endif %}>
                                        {{ label }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">&nbsp;</label>
                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-primary">Filter</button>
                                <a href="{% url 'clients:case_index' %}" class="btn btn-secondary">Clear</a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">Cases Management</h4>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table id="casesTable" class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th></th>
                                    <th>Case Title</th>
                                    <th>Client</th>
                                    <th>Balance</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for case in cases %}
                                <tr id="case-row-{{ case.id }}" data-case-id="{{ case.id }}">
                                    <td>
                                        <button class="btn btn-sm btn-outline-secondary" onclick="toggleTransactions({{ case.id }})" title="Show/Hide Transactions">
                                            <i class="fas fa-chevron-down" id="expand-icon-{{ case.id }}"></i>
                                        </button>
                                    </td>
                                    <td>
                                        <a href="{% url 'clients:case_detail' case.pk %}" class="text-decoration-none">
                                            {{ case.case_title|default:'-' }}
                                        </a>
                                    </td>
                                    <td>
                                        <a href="{% url 'clients:detail' case.client.pk %}" class="text-decoration-none">
                                            {{ case.client.full_name }}
                                        </a>
                                    </td>
                                    <td class="{{ case.get_balance_status_class }}">
                                        {{ case.get_formatted_balance }}
                                    </td>
                                    <td>
                                        {% if case.case_status == 'Open' %}
                                            <span class="badge bg-primary">{{ case.get_case_status_display }}</span>
                                        {% elif case.case_status == 'Pending Settlement' %}
                                            <span class="badge bg-warning">{{ case.get_case_status_display }}</span>
                                        {% elif case.case_status == 'Settled' %}
                                            <span class="badge bg-success">{{ case.get_case_status_display }}</span>
                                        {% elif case.case_status == 'Closed' %}
                                            <span class="badge bg-secondary">{{ case.get_case_status_display }}</span>
                                        {% else %}
                                            <span class="badge bg-dark">{{ case.get_case_status_display }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <a href="{% url 'clients:case_detail' case.pk %}" class="btn btn-sm btn-outline-info" title="View Details">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="editCase({{ case.pk }})" title="Edit">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="7" class="text-center">No cases found</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Transaction containers will be dynamically inserted after case rows -->
                    
                    <!-- Pagination -->
                    {% if is_paginated %}
                    <nav aria-label="Cases pagination" class="mt-4">
                        <ul class="pagination justify-content-center pagination-lg">
                            {% if page_obj.has_previous %}
                                <li class="page-item">
                                    <a class="page-link rounded-start shadow-sm" href="?page=1{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" title="Go to first page">
                                        <i class="fas fa-angle-double-left me-1"></i>First
                                    </a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link shadow-sm" href="?page={{ page_obj.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" title="Go to previous page">
                                        <i class="fas fa-angle-left me-1"></i>Previous
                                    </a>
                                </li>
                            {% else %}
                                <li class="page-item disabled">
                                    <span class="page-link rounded-start">
                                        <i class="fas fa-angle-double-left me-1 text-muted"></i>First
                                    </span>
                                </li>
                                <li class="page-item disabled">
                                    <span class="page-link">
                                        <i class="fas fa-angle-left me-1 text-muted"></i>Previous
                                    </span>
                                </li>
                            {% endif %}
                            
                            <li class="page-item active">
                                <span class="page-link bg-primary border-primary shadow-sm">
                                    <i class="fas fa-briefcase me-1"></i>
                                    Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
                                </span>
                            </li>
                            
                            {% if page_obj.has_next %}
                                <li class="page-item">
                                    <a class="page-link shadow-sm" href="?page={{ page_obj.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" title="Go to next page">
                                        Next<i class="fas fa-angle-right ms-1"></i>
                                    </a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link rounded-end shadow-sm" href="?page={{ page_obj.paginator.num_pages }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" title="Go to last page">
                                        Last<i class="fas fa-angle-double-right ms-1"></i>
                                    </a>
                                </li>
                            {% else %}
                                <li class="page-item disabled">
                                    <span class="page-link">
                                        Next<i class="fas fa-angle-right ms-1 text-muted"></i>
                                    </span>
                                </li>
                                <li class="page-item disabled">
                                    <span class="page-link rounded-end">
                                        Last<i class="fas fa-angle-double-right ms-1 text-muted"></i>
                                    </span>
                                </li>
                            {% endif %}
                        </ul>
                    </nav>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Case Modal -->
<div class="modal fade" id="caseModal" aria-labelledby="caseModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="caseModalLabel">Create New Case</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="caseModalForm" action="{% url 'clients:case_create' %}" method="post">
                <div class="modal-body">
                    {% csrf_token %}
                    <div id="caseModalContent">
                        <!-- Case form fields will be loaded here via AJAX -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="submitCaseForm()">
                        <i class="fas fa-save"></i> Save Case
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/datatables.min.js' %}"></script>
<script>
// Global modal instance
var caseModalInstance = null;

// Global functions for case modal
function loadCaseForm() {
    console.log('Loading case form...');
    
    // Clear any previous content
    $('#caseModalContent').empty();
    
    // Show modal with explicit configuration (no backdrop to avoid issues)
    $('#caseModal').modal({
        backdrop: false,
        keyboard: true,
        focus: true
    }).modal('show');
    
    // Load form content via AJAX
    $.ajax({
        url: '{% url "clients:case_create" %}',
        type: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        },
        success: function(response) {
            console.log('Response received:', response);
            if (response.form_html) {
                $('#caseModalContent').html(response.form_html);
            } else {
                console.error('No form_html in response');
                $('#caseModalContent').html('<div class="alert alert-danger">Error loading form. Please try again.</div>');
            }
        },
        error: function(xhr, status, error) {
            console.error('Error loading case form:', error);
            console.error('XHR:', xhr);
            $('#caseModalContent').html('<div class="alert alert-danger">Error loading form: ' + error + '</div>');
        }
    });
}

function submitCaseForm() {
    console.log('submitCaseForm called');
    var form = $('#caseModalForm');
    
    if (form.length === 0) {
        console.error('Form not found!');
        return;
    }
    
    var formData = form.serialize();
    var actionUrl = form.attr('action');
    
    console.log('Form action:', actionUrl);
    console.log('Form data:', formData);
    
    // Disable submit button to prevent double submission
    $('button[onclick="submitCaseForm()"]').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Saving...');
    
    $.ajax({
        url: actionUrl || '{% url "clients:case_create" %}',
        type: 'POST',
        data: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        },
        success: function(response) {
            console.log('Success response:', response);
            if (response.success) {
                $('#caseModal').modal('hide');
                location.reload(); // Refresh the page to show new case
            } else {
                // Re-enable button
                $('button[onclick="submitCaseForm()"]').prop('disabled', false).html('<i class="fas fa-save"></i> Save Case');
                
                if (response.form_html) {
                    $('#caseModalContent').html(response.form_html);
                } else {
                    alert('Error: ' + (response.message || 'Please check the form for errors.'));
                }
            }
        },
        error: function(xhr, status, error) {
            console.error('Error submitting form:', error);
            console.error('XHR status:', xhr.status);
            console.error('XHR response:', xhr.responseText);
            
            // Re-enable button
            $('button[onclick="submitCaseForm()"]').prop('disabled', false).html('<i class="fas fa-save"></i> Save Case');
            
            alert('Error creating case: ' + error);
        }
    });
}

// Edit case function
function editCase(caseId) {
    console.log('Loading edit form for case:', caseId);
    
    // Clear any previous content
    $('#caseModalContent').empty();
    
    // Update modal title
    $('#caseModalLabel').text('Edit Case');
    
    // Show modal with explicit configuration (no backdrop to avoid issues)
    $('#caseModal').modal({
        backdrop: false,
        keyboard: true,
        focus: true
    }).modal('show');
    
    // Update form action to edit URL
    $('#caseModalForm').attr('action', '/clients/cases/' + caseId + '/edit/');
    
    // Load form content via AJAX
    $.ajax({
        url: '/clients/cases/' + caseId + '/edit/',
        type: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        },
        success: function(response) {
            console.log('Edit form loaded successfully');
            if (response.form_html) {
                $('#caseModalContent').html(response.form_html);
            } else {
                $('#caseModalContent').html('<div class="alert alert-danger">Error loading form. Please try again.</div>');
            }
        },
        error: function(xhr, status, error) {
            console.error('Error loading edit form:', error);
            $('#caseModalContent').html('<div class="alert alert-danger">Error loading form: ' + error + '</div>');
        }
    });
}

// Toggle transactions for a case
function toggleTransactions(caseId) {
    let transactionRow = $('#transactions-row-' + caseId);
    const expandIcon = $('#expand-icon-' + caseId);
    const caseRow = $('#case-row-' + caseId);
    
    // Check if transaction row exists, if not create it
    if (transactionRow.length === 0) {
        // Create the transaction row HTML
        const transactionRowHtml = `
            <tr id="transactions-row-${caseId}" class="transaction-details" style="display: none;">
                <td colspan="7" class="p-0">
                    <div class="bg-light border-top" style="padding: 1rem; margin: 0 15px;">
                        <div id="transactions-content-${caseId}">
                            <!-- Transactions will be loaded here via AJAX -->
                            <div class="text-center py-2">
                                <i class="fas fa-spinner fa-spin"></i> Loading transactions...
                            </div>
                        </div>
                    </div>
                </td>
            </tr>
        `;
        
        // Insert the transaction row immediately after the case row
        caseRow.after(transactionRowHtml);
        transactionRow = $('#transactions-row-' + caseId);
    }
    
    const contentDiv = $('#transactions-content-' + caseId);
    
    if (transactionRow.is(':visible')) {
        // Collapse
        transactionRow.hide();
        expandIcon.removeClass('fa-chevron-up').addClass('fa-chevron-down');
    } else {
        // Expand
        transactionRow.show();
        expandIcon.removeClass('fa-chevron-down').addClass('fa-chevron-up');
        
        // Load transactions if not already loaded
        if (contentDiv.find('.fa-spinner').length > 0) {
            loadCaseTransactions(caseId);
        }
    }
}

// Load transactions for a specific case
function loadCaseTransactions(caseId) {
    const contentDiv = $('#transactions-content-' + caseId);
    
    $.ajax({
        url: '/clients/cases/' + caseId + '/transactions/',
        type: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        },
        success: function(response) {
            if (response.transactions && response.transactions.length > 0) {
                let transactionsHtml = '<div class="table-responsive">' +
                    '<table class="table table-sm table-hover mb-0">' +
                    '<thead class="table-secondary">' +
                    '<tr>' +
                    '<th>Date</th>' +
                    '<th>Type</th>' +
                    '<th>Description</th>' +
                    '<th>Amount</th>' +
                    '<th>Balance</th>' +
                    '</tr>' +
                    '</thead>' +
                    '<tbody>';
                
                response.transactions.forEach(function(transaction) {
                    transactionsHtml += '<tr>' +
                        '<td>' + transaction.date + '</td>' +
                        '<td><span class="badge ' + transaction.type_class + '">' + transaction.type + '</span></td>' +
                        '<td>' + (transaction.description || '-') + '</td>' +
                        '<td class="' + transaction.amount_class + '">' + transaction.amount_display + '</td>' +
                        '<td class="fw-bold">' + transaction.balance_display + '</td>' +
                        '</tr>';
                });
                
                transactionsHtml += '</tbody></table></div>';
                contentDiv.html(transactionsHtml);
            } else {
                contentDiv.html('<div class="text-center py-3 text-muted">' +
                    '<i class="fas fa-receipt fa-2x mb-2"></i><br>' +
                    'No transactions found for this case.' +
                    '</div>');
            }
        },
        error: function(xhr, status, error) {
            console.error('Error loading transactions:', error);
            console.error('XHR status:', xhr.status);
            console.error('XHR response:', xhr.responseText);
            contentDiv.html('<div class="alert alert-danger">Error loading transactions. Please try again.</div>');
        }
    });
}

$(document).ready(function() {
    // Clean up modal on close
    $('#caseModal').on('hidden.bs.modal', function () {
        console.log('Modal hidden');
        $('#caseModalContent').empty(); // Clear content
    });
    
    // Initialize DataTable
    var casesTable = $('#casesTable').DataTable({
        "pageLength": 25,
        "order": [[ 0, "desc" ]],
        "searching": false,
        "lengthChange": false,
        "paging": false,  // Disable DataTables pagination
        "info": true,     // Keep "Showing 1 to X of Y entries" info
        "columnDefs": [
            { "orderable": false, "targets": [0, 5] }
        ]
    });
    
    // Dynamic Search Implementation
    let searchTimeout;
    const searchInput = $('#search');
    const searchSpinner = $('#search-spinner');
    const clientFilter = $('#client');
    const statusFilter = $('#status');
    
    searchInput.on('input', function() {
        const query = $(this).val().trim();
        
        // Clear previous timeout
        clearTimeout(searchTimeout);
        
        // If query is less than 2 characters, don't search
        if (query.length < 2) {
            return;
        }
        
        // Show loading spinner
        searchSpinner.show();
        
        // Debounce search requests by 300ms
        searchTimeout = setTimeout(function() {
            performSearch(query);
        }, 300);
    });
    
    function performSearch(query) {
        $.ajax({
            url: '{% url "clients:ajax_search_cases" %}',
            type: 'GET',
            data: {
                'q': query,
                'client': clientFilter.val(),
                'status': statusFilter.val(),
                'limit': 50
            },
            success: function(response) {
                updateTable(response.cases);
                searchSpinner.hide();
            },
            error: function(xhr, status, error) {
                console.error('Search error:', error);
                searchSpinner.hide();
                // Show error message
                casesTable.clear().draw();
                casesTable.row.add([
                    '<td colspan="7" class="text-center text-danger">' +
                    '<i class="fas fa-exclamation-triangle"></i> Search error. Please try again.' +
                    '</td>',
                    '', '', '', '', '', ''
                ]).draw();
            }
        });
    }
    
    function updateTable(cases) {
        // Clear existing table data
        casesTable.clear();
        
        if (cases.length === 0) {
            casesTable.row.add([
                '<td colspan="7" class="text-center">No cases found matching your search</td>',
                '', '', '', '', '', ''
            ]).draw();
            return;
        }
        
        // Add new rows
        cases.forEach(function(caseData) {
            var statusBadge = '<span class="badge ' + caseData.status_class + '">' + caseData.case_status_display + '</span>';
                
            var actionsHtml = 
                '<div class="btn-group" role="group">' +
                '<a href="/clients/cases/' + caseData.id + '/" class="btn btn-sm btn-outline-info" title="View Details">' +
                '<i class="fas fa-eye"></i></a>' +
                '<button type="button" class="btn btn-sm btn-outline-primary" onclick="editCase(' + caseData.id + ')" title="Edit">' +
                '<i class="fas fa-edit"></i></button>' +
                '</div>';
            
            // Add expand/collapse button
            var expandButton = '<button class="btn btn-sm btn-outline-secondary" onclick="toggleTransactions(' + caseData.id + ')" title="Show/Hide Transactions">' +
                '<i class="fas fa-chevron-down" id="expand-icon-' + caseData.id + '"></i>' +
                '</button>';
            
            casesTable.row.add([
                expandButton,
                '<a href="/clients/cases/' + caseData.id + '/" class="text-decoration-none">' + caseData.case_number + '</a>',
                '<a href="/clients/' + caseData.client_id + '/" class="text-decoration-none">' + caseData.client_name + '</a>',
                caseData.balance_display || '-',
                statusBadge,
                actionsHtml
            ]);
        });
        
        casesTable.draw();
    }
});
</script>
{% endblock %}

{% block help_content %}
<p>The <strong>Cases</strong> page manages all legal cases for your clients.</p>
<h6><i class="fas fa-briefcase"></i> Case Management</h6>
<p>Each case represents a specific legal matter for a client:</p>
<ul>
    <li><strong>Case Title:</strong> Unique identifier for the case</li>
    <li><strong>Client:</strong> The client this case belongs to</li>
    <li><strong>Title:</strong> Brief description of the case</li>
    <li><strong>Amount:</strong> Total case value or settlement amount</li>
    <li><strong>Status:</strong> Current case status (Open, Pending Settlement, Settled, Closed)</li>
</ul>
<h6><i class="fas fa-search"></i> Search and Filter</h6>
<p>Use the search and filter options to find specific cases by case number, title, client name, or status.</p>
<h6><i class="fas fa-tools"></i> Actions</h6>
<ul>
    <li><i class="fas fa-eye"></i> <strong>View:</strong> See case details, transactions, and settlements</li>
    <li><i class="fas fa-edit"></i> <strong>Edit:</strong> Update case information</li>
</ul>
{% endblock %}