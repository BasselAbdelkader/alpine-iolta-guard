{% extends 'base.html' %}
{% load static %}

{% block title %}3-Way Reconciliation - {{ settlement.settlement_number }}{% endblock %}

{% block page_title %}3-Way Reconciliation - {{ settlement.settlement_number }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-3">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <a href="{% url 'settlements:detail' settlement.pk %}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Back to Settlement
                </a>
                <div class="d-flex gap-2">
                    <a href="{% url 'settlements:edit' settlement.pk %}" class="btn btn-outline-primary">
                        <i class="fas fa-edit"></i> Edit Settlement
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-4">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-university"></i> Bank Account</h5>
                </div>
                <div class="card-body">
                    <h6>{{ settlement.bank_account.bank_name }}</h6>
                    <p class="text-muted">{{ settlement.bank_account.account_name }}</p>
                    
                    <table class="table table-sm">
                        <tr>
                            <th>Balance Before:</th>
                            <td>${{ reconciliation.bank_balance_before|floatformat:2 }}</td>
                        </tr>
                        <tr>
                            <th>Expected After:</th>
                            <td>${{ reconciliation.bank_balance_before|floatformat:2|add:reconciliation.total_distributions|floatformat:2 }}</td>
                        </tr>
                        <tr>
                            <th>Actual After:</th>
                            <td class="{% if reconciliation.bank_balance_after %}text-success{% else %}text-muted{% endif %}">
                                {% if reconciliation.bank_balance_after %}
                                    ${{ reconciliation.bank_balance_after|floatformat:2 }}
                                {% else %}
                                    Not set
                                {% endif %}
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-user"></i> Client</h5>
                </div>
                <div class="card-body">
                    <h6>{{ settlement.client.full_name }}</h6>
                    <p class="text-muted">{{ settlement.client.client_number }}</p>
                    
                    <table class="table table-sm">
                        <tr>
                            <th>Balance Before:</th>
                            <td>${{ reconciliation.client_balance_before|floatformat:2 }}</td>
                        </tr>
                        <tr>
                            <th>Expected After:</th>
                            <td>${{ reconciliation.client_balance_before|floatformat:2|add:settlement.total_amount|floatformat:2 }}</td>
                        </tr>
                        <tr>
                            <th>Actual After:</th>
                            <td class="{% if reconciliation.client_balance_after %}text-success{% else %}text-muted{% endif %}">
                                {% if reconciliation.client_balance_after %}
                                    ${{ reconciliation.client_balance_after|floatformat:2 }}
                                {% else %}
                                    Not set
                                {% endif %}
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="fas fa-balance-scale"></i> Reconciliation</h5>
                </div>
                <div class="card-body">
                    <div class="text-center">
                        <div class="mb-3">
                            <span class="badge badge-lg bg-{% if reconciliation.is_balanced %}success{% else %}danger{% endif %}">
                                {{ reconciliation.get_reconciliation_status_display }}
                            </span>
                        </div>
                        
                        {% if reconciliation.balance_difference != 0 %}
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i>
                            <strong>Balance Difference:</strong><br>
                            ${{ reconciliation.balance_difference|floatformat:2 }}
                        </div>
                        {% endif %}
                    </div>
                    
                    <table class="table table-sm">
                        <tr>
                            <th>Settlement Amount:</th>
                            <td>${{ settlement.total_amount|floatformat:2 }}</td>
                        </tr>
                        <tr>
                            <th>Total Distributions:</th>
                            <td>${{ reconciliation.total_distributions|floatformat:2 }}</td>
                        </tr>
                        <tr>
                            <th>Difference:</th>
                            <td class="{% if settlement.remaining_balance == 0 %}text-success{% else %}text-danger{% endif %}">
                                ${{ settlement.remaining_balance|floatformat:2 }}
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Distributions Summary</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Type</th>
                                    <th>Recipient</th>
                                    <th>Amount</th>
                                    <th>Check #</th>
                                    <th>Status</th>
                                    <th>Description</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for distribution in distributions %}
                                <tr>
                                    <td>{{ distribution.get_distribution_type_display }}</td>
                                    <td>
                                        {% if distribution.vendor %}
                                            <i class="fas fa-building text-primary"></i> {{ distribution.vendor.vendor_name }}
                                        {% elif distribution.client %}
                                            <i class="fas fa-user text-success"></i> {{ distribution.client.full_name }}
                                        {% endif %}
                                    </td>
                                    <td>${{ distribution.amount|floatformat:2 }}</td>
                                    <td>{{ distribution.check_number|default:"-" }}</td>
                                    <td>
                                        {% if distribution.is_paid %}
                                            <span class="badge bg-success">Paid</span>
                                        {% else %}
                                            <span class="badge bg-warning">Pending</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ distribution.description|default:"-" }}</td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="6" class="text-center">No distributions found</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Perform Reconciliation</h5>
                </div>
                <div class="card-body">
                    {% if not settlement.is_balanced %}
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Warning:</strong> The settlement is not balanced. The total distributions ({{ reconciliation.total_distributions|floatformat:2 }}) 
                        do not equal the settlement amount ({{ settlement.total_amount|floatformat:2 }}). 
                        Please add or modify distributions before performing reconciliation.
                    </div>
                    {% endif %}
                    
                    <form method="post">
                        {% csrf_token %}
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Current Bank Balance</label>
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        <input type="number" name="bank_balance_after" step="0.01" 
                                               class="form-control" placeholder="Enter current bank balance" 
                                               value="{{ reconciliation.bank_balance_after|default:'' }}">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Current Client Balance</label>
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        <input type="number" name="client_balance_after" step="0.01" 
                                               class="form-control" placeholder="Enter current client balance" 
                                               value="{{ reconciliation.client_balance_after|default:'' }}">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-12">
                                <div class="form-group">
                                    <label>Reconciliation Notes</label>
                                    <textarea name="notes" class="form-control" rows="3" 
                                              placeholder="Enter any notes about the reconciliation">{{ reconciliation.notes|default:'' }}</textarea>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-flex justify-content-end">
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-balance-scale"></i> Perform Reconciliation
                            </button>
                        </div>
                    </form>
                    
                    {% if reconciliation.reconciled_at %}
                    <div class="mt-3 pt-3 border-top">
                        <p class="text-muted mb-0">
                            <i class="fas fa-clock"></i> Last reconciled on {{ reconciliation.reconciled_at|date:"F d, Y g:i A" }}
                            {% if reconciliation.reconciled_by %}by {{ reconciliation.reconciled_by }}{% endif %}
                        </p>
                        {% if reconciliation.notes %}
                        <div class="mt-2">
                            <strong>Notes:</strong>
                            <p class="text-muted">{{ reconciliation.notes|linebreaks }}</p>
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block help_content %}
The 3-way reconciliation ensures that the bank account balance, client balance, and settlement distributions are all in agreement. 
Enter the current balances and click "Perform Reconciliation" to check if everything balances correctly.
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Auto-refresh reconciliation status every 30 seconds
    setInterval(function() {
        fetch(`/settlements/{{ settlement.pk }}/balance-check/`)
            .then(response => response.json())
            .then(data => {
                if (data.is_balanced) {
                    $('.badge:contains("Unbalanced")').removeClass('bg-danger').addClass('bg-success').text('Balanced');
                } else {
                    $('.badge:contains("Balanced")').removeClass('bg-success').addClass('bg-danger').text('Unbalanced');
                }
            });
    }, 30000);
});
</script>
{% endblock %}