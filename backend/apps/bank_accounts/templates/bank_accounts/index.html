{% extends 'base.html' %}
{% load static %}
{% load humanize %}
{% load accounting_filters %}

{% block title %}Bank Accounts Management{% endblock %}

{% block page_title %}{% if global_law_firm %}{{ global_law_firm.firm_name }}{% else %}Bank Accounts{% endif %}{% endblock %}

{% block help_title %}Bank Accounts{% endblock %}

{% block extra_css %}
<link href="{% static 'css/datatables.min.css' %}" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">Bank Accounts Management</h4>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table id="bankAccountsTable" class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Account Number</th>
                                    <th>Bank Name</th>
                                    <th>Register Balance</th>
                                    <th>Status</th>
                                    <th>Created Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for account in bank_accounts %}
                                <tr>
                                    <td>
                                        <a href="{% url 'bank_accounts:bank_transactions' %}" class="text-decoration-none">
                                            {{ account.account_number }}
                                        </a>
                                    </td>
                                    <td>{{ account.bank_name }}</td>
                                    <td class="{{ account.get_current_balance|balance_status_class }}">
                                        {{ account.get_current_balance|format_amount_accounting }}
                                    </td>
                                    <td>
                                        {% if account.is_active %}
                                            <span class="badge bg-success">Active</span>
                                        {% else %}
                                            <span class="badge bg-secondary">Inactive</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ account.created_at|date:"m/d/Y" }}</td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="5" class="text-center">No bank accounts found</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete bank account <strong id="accountName"></strong>?</p>
                <p class="text-muted">This action cannot be undone and may affect related transactions.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form id="deleteForm" method="post" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">Delete</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/datatables.min.js' %}"></script>
<script>
$(document).ready(function() {
    $('#bankAccountsTable').DataTable({
        "pageLength": 25,
        "order": [[ 4, "desc" ]],
        "searching": false,  // Disable DataTables search box
        "lengthChange": false,  // Disable "Show X entries" dropdown
        "paging": false,  // Disable pagination
        "info": false  // Disable "Showing 1 to 1 of 1 entries" info
    });
});

function confirmDelete(accountId, accountName) {
    document.getElementById('accountName').textContent = accountName;
    document.getElementById('deleteForm').action = "{% url 'bank_accounts:delete' 0 %}".replace('0', accountId);
    new bootstrap.Modal(document.getElementById('deleteModal')).show();
}
</script>
{% endblock %}

{% block help_content %}
<p>The <strong>Bank Accounts</strong> page manages your trust account banking information and reconciliation records.</p>

<h6><i class="fas fa-university"></i> Understanding Account Balances</h6>
<p><strong>Register Balance</strong> shows cleared transactions only - this is the actual money in your bank account according to your bank statement.</p>
<p><strong>Trust Balance</strong> includes ALL transactions (cleared + pending) - this represents your total obligation to clients.</p>
<p><em>The difference between these balances equals your pending transactions.</em></p>

<h6><i class="fas fa-plus-circle"></i> Adding Bank Accounts</h6>
<p>Click "Add New Bank Account" to register additional accounts. Include:</p>
<ul>
    <li><strong>Account Details:</strong> Account number, routing number, bank name</li>
    <li><strong>Account Type:</strong> Trust Account, Operating Account, or Escrow Account</li>
    <li><strong>Opening Balance:</strong> Should be $0.00 (create opening balance as a transaction instead)</li>
</ul>

<h6><i class="fas fa-balance-scale"></i> Reconciliation</h6>
<p>Regular reconciliation ensures accuracy between your records and bank statements. Track cleared and pending transactions.</p>

<h6><i class="fas fa-tools"></i> Actions</h6>
<ul>
    <li><i class="fas fa-eye"></i> <strong>View:</strong> See account details and transaction history</li>
    <li><i class="fas fa-edit"></i> <strong>Edit:</strong> Update account information</li>
    <li><i class="fas fa-sync"></i> <strong>Reconcile:</strong> Perform monthly reconciliation</li>
</ul>
{% endblock %}